<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crypto Chart</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>  <!-- Chart.js library -->
</head>

<body>

  <h1>Crypto Chart</h1>

  <button id="btc">BTC</button> <span id="btc-price"></span>  <!-- Button and price for BTC-USD -->
  <button id="eth">ETH</button> <span id="eth-price"></span>  <!-- Button and price for ETH-USD -->
  <button id="chz">CHZ</button> <span id="chz-price"></span>  <!-- Button and price for CHZ-USD -->

  <br>

  <button id="day">Day</button> 
  <button id="week">Week</button> 
  <button id="month">Month</button> 

  <canvas id="cryptoChart"></canvas>  <!-- Canvas for chart -->

  <script>

    let symbol = 'BTC-USD';  // Default symbol
    let timeframe = '1mo'
  
    // Function to fetch data and update the chart
    function fetchData() {
      fetch(`http://localhost:3000/finance/${symbol}/${timeframe}`)
        .then(response => response.json())
        .then(data => {
          const ctx = document.getElementById('cryptoChart').getContext('2d');
  
          // If the chart already exists, destroy it to create a new one
          if(window.myChart) {
            window.myChart.destroy();
          }
  
          const chartData = data.quotes.map(q => q.close);  // Use closing prices
          const labels = data.quotes.map(q => q.date.substring(0, 10));  // Dates
  
          window.myChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: `${symbol} Price`,
                data: chartData,
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1
              }]
            },
          });
        })
        .catch(err => console.error("Error loading chart data: ", err));
    } 
      
    // Function to fetch and update the price of an asset
    function updatePrice(assetSymbol, displayElementId) {
        fetch(`http://localhost:3000/finance/${assetSymbol}`)
            .then(response => response.json())
            .then(data => {
                // Utilisez les données directement renvoyées par l'API
                const priceFormatted = Number(data.regularMarketPrice).toFixed(2);  // Format price with 2 decimal places
                document.getElementById(displayElementId).textContent = `Price: $${priceFormatted}`;
            })
            .catch(err => console.error("Error loading data: ", err));
    }

      
    // Update the price and fetch data when a button is clicked
    document.getElementById('btc').addEventListener('click', () => {
        symbol = 'BTC-USD';
        fetchData();  // Update chart
        updatePrice(symbol,'btc-price');  // Update price
    });
      
    document.getElementById('eth').addEventListener('click', () => {
        symbol = 'ETH-USD';
        fetchData();  // Update chart
        updatePrice(symbol,'eth-price');  // Update price
    });

    document.getElementById('chz').addEventListener('click', () => {
        symbol = 'CHZ-USD';
        fetchData();  // Update chart
        updatePrice(symbol,'chz-price');  // Update price
        });

    document.getElementById('day').addEventListener('click', () => {
        timeframe = '1d';
        fetchData();  // Update chart
        });
    
    document.getElementById('week').addEventListener('click', () => {
        timeframe = '1wk';
        fetchData();  // Update chart
        });

    document.getElementById('month').addEventListener('click', () => {
        timeframe = '1mo';
        fetchData();  // Update chart
        });
      
    // Initial calls
    fetchData();
    updatePrice('BTC-USD','btc-price');
    updatePrice('ETH-USD','eth-price');
    updatePrice('CHZ-USD','chz-price');
      
    // Set an interval to fetch data and update the chart every minute (60000 milliseconds)
    // Update prices every minute
    setInterval(() => {
        fetchData();
        updatePrice('BTC-USD','btc-price');
        updatePrice('ETH-USD','eth-price');
        updatePrice('CHZ-USD','chz-price');
    }, 60000);
    
  </script>
</body>
</html>
